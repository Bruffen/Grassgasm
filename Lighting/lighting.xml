<?xml version="1.0" ?>
<project name="Lighting" width = "1280" height = "720">
    <assets>
    	<attributes>
            <attribute name="m_view"        data="MAT4" type="RENDERER" />
            <attribute name="m_proj"        data="MAT4" type="RENDERER" />
            <attribute name="m_pv"          data="MAT4" type="RENDERER" />
            <!--Skybox-->
            <attribute name="sun_cutoff"    data="FLOAT" type="RENDERER" value=20 />
            <attribute name="sun_fade"      data="FLOAT" type="RENDERER" value=10 />
            <attribute name="sun_screenPos" data="VEC2"  type="RENDERER" x=0.5 y=0.5 />
            <!--GodRays-->
			<attribute name="num_samples"   data="INT"   type="RENDERER" value=60 />
            <attribute name="ray_length"    data="FLOAT" type="RENDERER" value=0.85 />
            <!--Grass-->
            <attribute name="translucency"  data="FLOAT" type="RENDERER" value=1.25 />
            <attribute name="scattering"    data="FLOAT" type="RENDERER" value=90.0 />

		</attributes>
		
        <scenes>
            <scene name = "Skybox">
                <geometry name = "cube_skybox" type = "BOX" material="mat_skybox"/>
            </scene>
            <scene name = "Axis">
                <geometry name = "axis" type = "AXIS" />
            </scene>
            <scene name = "Sphere">
                <geometry name = "sphere" type = "SPHERE" />
                <TRANSLATE x=0 y=0 z=-1 />
            </scene>
            <scene name = "Plane">
                <geometry name = "plane" type = "SQUARE" />
                <SCALE x=100 y=1 z=100 />
                <TRANSLATE x=0 y=-2 z=0 />
            </scene>
            <scene name = "Leaf">
                <geometry name = "plane" type = "SQUARE" material="mat_grass"/>
                <SCALE x=1 y=1 z=1 />
                <ROTATE x=1 y=0 z=-1 w=90 />
                <TRANSLATE x=-5 y=-1 z=-5 />
            </scene>
        </scenes>

        <viewports>
            <viewport name="MainViewport">
                <CLEAR_COLOR r="0.6" g="0.8" b="0.7" />
            </viewport>
        </viewports>

        <cameras>
            <camera name="MainCamera" >
                <viewport name="MainViewport" />
                <POSITION x=0 y=0 z=0 />
                <VIEW x=0.0 y=0.0 z=-1.0 />
                <UP x=0 y=1 z=0 />
                <NEAR value=0.01 />
            </camera>
        </cameras>

        <lights>
            <light name="Sun">
                <DIRECTION x="1.0" y="-1.0" z="-1.0" />
                <COLOR r="1.0" g="1.0" b="0.96" />
            </light>
        </lights>

        <materialLibs>
			<materialLib filename="materials/skybox.mlib" />
            <materialLib filename="materials/postprocess.mlib" />
            <materialLib filename="materials/grass.mlib" />
		</materialLibs>
    </assets>

    <pipelines>
        <pipeline name="Lighting" default="true">
            <pass class="default" name="Pass">
                <preScript file="scripts/setup.lua" script="calcSunScreenPosition" />
                <scenes>
                    <scene name="Skybox" />
                    <scene name="Axis" />
                    <scene name="Sphere" />
                    <scene name="Plane" />
                    <scene name="Leaf" />
                </scenes>
                <camera name="MainCamera" />
                <viewport name="MainViewport" />
                <lights>
                    <light name="Sun" />
                </lights>
                <injectionMaps>
					<map toMaterial="mat_skybox">
						<state name="cull" fromLibrary="Lighting#Pass" />
					</map>
				</injectionMaps>
                <materialMaps>
                    <map fromMaterial="*"
                         toMaterial="mat_grass" toLibrary="Grass"/>
					<map fromMaterial="mat_skybox" 
                         toMaterial="mat_skybox" toLibrary="Lighting#Pass"/>
				</materialMaps>
                <renderTarget name="Source" fromLibrary="PostProcessing" />
            </pass>

            <!-- Post Processing -->

            <pass class="quad" name="PostProcess_Setup">
				<materialMaps>
				    <map fromMaterial="__Quad" toMaterial="mat_brightness" toLibrary="PostProcessing"/>
				</materialMaps>
                <renderTarget name="Brightness" fromLibrary="PostProcessing" />
			</pass>
            <pass class="quad" name="PostProcess_Effects">
                <camera name="MainCamera" />
				<viewport name="MainViewport" />
				<materialMaps>
					<map fromMaterial="__Quad" toMaterial="mat_radialblur" toLibrary="PostProcessing"/>
				</materialMaps>
			</pass>
        </pipeline>
    </pipelines>

    <interface> 
        <window label="Skybox">
            <var label="Sun color" type="LIGHT" context="Sun" component="COLOR"/>
            <var label="Sun size" type="RENDERER" context="CURRENT" component="sun_cutoff" def="min=0 step=0.05"/>
            <var label="Sun fade" type="RENDERER" context="CURRENT" component="sun_fade" def="min=0 step=0.05"/>
            <var label="Sun direction" type="LIGHT" context="Sun" component="DIRECTION" />
        </window>
        <window label="God rays"> 
            <var label="Samples" type="RENDERER" context="CURRENT" component="num_samples" def="min=0 max=200" /> 
            <var label="Ray length" type="RENDERER" context="CURRENT" component="ray_length" def="min=0 max=1 step=0.01"/> 
        </window>
        <window label="Grass"> 
            <var label="Scattering" type="RENDERER" context="CURRENT" component="scattering" def="min=0 max=200" /> 
            <var label="Translucency" type="RENDERER" context="CURRENT" component="translucency" def="min=0 max=10 step=0.01"/> 
        </window>
    </interface>   
</project>